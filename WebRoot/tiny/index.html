<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="/js/tinymce/tinymce.min.js"></script>
    <script src="/js/baseFunction.js"></script>
    <script>
        var imagesUploadUrl = getAddress() + "blog/context/uploadImage";

        // 富文本编辑器图片上传功能
        const imageUploadHandler = (blobInfo, progress) => new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.withCredentials = false;
            xhr.open('POST', imagesUploadUrl);
            xhr.upload.onprogress = (e) => {
                progress(e.loaded / e.total * 100);
            };
            xhr.onload = () => {
                if (xhr.status === 403) {
                    reject({ message: 'HTTP Error: ' + xhr.status, remove: true });
                    return;
                }
                if (xhr.status < 200 || xhr.status >= 300) {
                    reject('HTTP Error: ' + xhr.status);
                    return;
                }
                const json = JSON.parse(xhr.responseText);
                if (!json.obj || typeof json.obj.location != 'string') {
                    reject('Invalid JSON: ' + xhr.responseText);
                    return;
                }
                resolve(json.obj.location);
            };
            xhr.onerror = () => {
                reject('Image upload failed due to a XHR Transport error. Code: ' + xhr.status);
            };
            const formData = new FormData();
            formData.append('image', blobInfo.blob());
            formData.append('imageName', blobInfo.filename());
            xhr.send(formData);
        });

        tinymce.init({
            selector: '#tinyDemo', // 容器，可使用css选择器
            // language_url: '/js/tinymce/langs/zh-Hans.js',
            language: 'zh-Hans', // 调用放在langs文件夹内的语言包
            // toolbar: true, // 工具栏
            toolbar: 'bold italic forecolor | fontsize | removeformat alignleft aligncenter alignright alignjustify bullist numlist checklist outdent indent | table link image codesample code',
            // font_size_formats: "12px 14px 16px 18px 20px 24px 36px 48px 56px 72px",
            // images_upload_url: imagesUploadUrl, // 图片上传URL
            images_upload_handler: imageUploadHandler,
            // images_upload_handler: function (blobInfo, succFun, failFun) {
            //     var image = blobInfo.blob();
            //     var formData = new FormData();
            //     formData.append('image', image);
            //     formData.append('imageName', image.name);
            //     var result = ajax("post", "blog/uploadImage", false, formData);
            //     if (!result || typeof result.location != 'string') {
            //         failFun('Invalid JSON: ' + result);
            //         return;
            //     }
            //     console.log("result.location = " + result.location);
            //     succFun(result.location);
            // },
            menubar: false, // 菜单栏
            branding: false, // 不显示logo
            promotion: false, // 不显示升级按钮

            plugins: ['table', 'link', 'image', 'codesample', 'code']   // 插件
            // 选中时出现的快捷工具，与插件有依赖关系
            // quickbars_selection_toolbar: 'bold italic forecolor | link blockquote quickimage',
        });

        function btn() {
            var value = tinyMCE.activeEditor.getContent();
            var title = document.getElementById('title').value;
            var formData = new FormData();
            if (title == null || title == '') {
                alert("请输入标题! ");
                return;
            }
            if (value == null || value == '') {
                alert("请输入正文! ");
                return;
            }
            
            formData.append('title', title);    
            formData.append('context', value);
            ajax("post", "blog/context/uploadContext", false, formData);

            window.location.href = '../blog/index.html';
        }
    </script>
</head>

<body>
    <input type="text" id="title" placeholder="请输入标题">
    <textarea id="tinyDemo" style="width: auto;">HelloWorld</textarea><br>
    <input type="button" id="tinyCheck" onclick="btn()" value="提交">
</body>

</html>