<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="/resource/js/jstree/themes/default/style.min.css">
    <link rel="stylesheet" type="text/css" href="/resource/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/resource/css/baseCss.css">
    <script src="/resource/js/baseFunction.js"></script>
    <script src="/resource/js/jquery-3.6.3.min.js"></script>
    <script src="/resource/js/jstree/jstree.min.js"></script>
    <script src="/resource/js/bootstrap.min.js"></script>
    <script>
        function init() {
            document.getElementById('btnField').disabled = true;

            // // 目录树初始化
            // $(function () { $('#jstree_demo_div').jstree(); });
        }


        function checkFileName(file) {
            if (file.length > 0) {
                document.getElementById('textField').value = file[0].name;
                document.getElementById('btnField').disabled = false;
            }
        }

        function uploadFile() {
            console.log("WWWWWWW");
            var files = document.getElementById('fileField').files;
            var fileName = document.getElementById('textField').value;
            // console.log("file[0].name = " + files[0].name);
            if (files.length > 0) {
                var formData = new FormData();
                formData.append('file', files[0]);
                formData.append('fileName', fileName);
                formData.append('folderId', "063b69964a4d41b781fed821170c4d36");
                var result = ajax("POST", "attachedStorage/uploadFile", false, formData);
            }
        }

        function downloadFile() {
            var realName = "8dce300dc6df4a65be4b37250be693d4.jpg";
            window.location.href = getAddress() + "attachedStorage/downloadFile?realName=" + realName;
        }

        function getFolderAndFile(folderId) {
            var data = {};
            data.folderId = "" + folderId;
            var result = ajaxJson("POST", "attachedStorage/getFolderAndFile", false, data);
            console.log("result", result);
        }

        function showFolderAndFile() {
            document.getElementById('folderAndFile').innerHTML +=
                    '<div class="media">' +
                    '<div class="media-left">' +
                    '<a><img class="media-object img-thumbnail pointerCursor" src="' + getAddress() + thumbnail + '" alt="' + context.title + '" onclick="contextShow(\'' + context.uuid + '\')"></a>' +
                    '</div>' +
                    '<div class="media-body">' +
                    '<h4 class="media-heading"><span class="pointerCursor" onclick="contextShow(\'' + context.uuid + '\')">' + context.title + '</span></h4>' +
                    '<span class="pointerCursor" onclick="contextShow(\'' + context.uuid + '\')">' + context.brief + '</span>' +
                    '<p class="contextInfo">' +
                    '<span><span class="glyphicon glyphicon-user" aria-hidden="true"></span>&nbsp;' +
                    '<span id="popUser' + ran.substring(2) + '" class="popoverShow" tabindex="0" data-toggle="popover" onclick="popUserInfoPreview(this)">' + context.user + '</span>' +
                    '</span>' +
                    '&nbsp;&nbsp;' +
                    '<span class="glyphicon glyphicon-calendar" aria-hidden="true"></span>&nbsp;' +
                    context.update_time +
                    '</p>' +
                    '</div>' +
                    '</div>';
        }
    </script>
</head>

<body onload="init()">
    <div style="max-width: 80%; margin: auto; padding: 5px; border-radius: 10px;">


        <fieldset>
            <legend>文件上传</legend>
            <div>
                <input type="text" name="fileName" id="textField" class="txt">
                <input type="file" name="file" class="file" id="fileField" onchange="checkFileName(files)">
                <input type="button" id="btnField" class="btn" value="上传" onclick="uploadFile()" />
            </div>
        </fieldset>
        <fieldset>
            <legend>文件下载</legend>
            <input type="button" onclick="downloadFile()" value="点击下载">
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
        </fieldset>

        <fieldset>
            <legend>jsTree测试</legend>
            <div id="jstree" class="col-md-2"></div>
            <div id="internal" class="col-md-10">
                <div>
                    <input type="button" value="新建文件夹">
                    <input type="button" value="上传文件">
                </div>
                <div id="folderAndFile">

                </div>
            </div>

            <script>
                $(function () {

                    // 6 create an instance when the DOM is ready
                    $('#jstree').jstree({
                        "core": {
                            "themes": {
                                "variant": "large"
                            },
                            "multiple": false,
                            "animation": 0,
                            "data": function (obj, callback) {
                                var jsonArray = eval("([])");
                                var requestBody = { null: "null" }
                                $.ajax({
                                    type: "POST",
                                    url: getAddress() + "attachedStorage/getFolderInFlat",
                                    contentType: "application/json; charset=utf-8",
                                    data: JSON.stringify(requestBody),
                                    dataType: "json",
                                    async: false,
                                    success: function (result) {
                                        var arrays = result.obj;
                                        for (var i = 0; i < arrays.length; i++) {
                                            var arr = {
                                                "id": arrays[i].folderId,
                                                "parent": arrays[i].parentId == "root" ? "#" : arrays[i].parentId,
                                                "text": arrays[i].folderName
                                            }
                                            jsonArray.push(arr);
                                        }
                                    }
                                });
                                callback.call(this, jsonArray);
                            }
                        },
                        // "checkbox": {
                        //     "keep_selected_style": false
                        // },
                        "conditionalselect": function (node, event) {
                            return false;
                        },
                        "plugins": ["wholerow", "dnd", "changed"]
                    });

                    $('#jstree').on("changed.jstree", function (e, data) {
                        console.log("data.selected = " + data.selected);
                        getFolderAndFile(data.selected);
                    });
                });
            </script>
        </fieldset>
    </div>
</body>

</html>